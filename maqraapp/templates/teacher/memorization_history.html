<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>سجل الحفظ للحلقة</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}"/>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .summary-table {
            width: 50%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .summary-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    {% include 'parts/header.html' %}
    <div class="container">
        <h1 class="text-center my-4">سجل الحفظ للحلقة: {{ halaqa.name }}</h1>

        <h2>تفاصيل الحفظ</h2>
        <table>
            <thead>
                <tr>
                    <th>الطالب</th>
                    <th>التاريخ</th>
                    <th>نوع المهمة</th>
                    <th>من سورة</th>
                    <th>من آية</th>
                    <th>إلى سورة</th>
                    <th>إلى آية</th>
                    <th>عدد الصفحات</th>
                    <th>أجزاء الصفحة</th>
                    <th>عدد الآيات</th>
                </tr>
            </thead>
            <tbody>
                {% for record in memorization_records %}
                <tr>
                    <td>{{ record.student.first_name }} {{ record.student.last_name }}</td>
                    <td>{{ record.date }}</td>
                    <td>{{ record.get_MemorizationTask_display }}</td>
                    <td>{{ record.previous_surah }}</td>
                    <td>{{ record.previous_ayat }}</td>
                    <td>{{ record.current_surah }}</td>
                    <td>{{ record.current_ayat }}</td>
                    <td>{{ record.pages }}</td>
                    <td>{{ record.partial_page }}</td>
                    <td>{{ record.memorized_ayat_count }}</td>
                </tr>
{% empty %}
                <tr>
                    <td colspan="10">لا يوجد سجلات حفظ لهذه الحلقة.</td> {# Increased colspan to 10 #}
                </tr>
{% endfor %}
                <tr>
                    <td colspan="10" style="text-align: center;">© الخوارزمي للحلول الذكية</td>
                </tr>
            </tbody>
        </table>

        <h2>الملخص الإجمالي للحلقة</h2>
        <table class="summary-table" id="summaryTable"> {# Added ID to summary table #}
            <thead>
                <tr>
                    <th>المجموع الكلي للآيات المحفوظة</th>
                    <th>المجموع الكلي للصفحات المحفوظة</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ total_verses }}</td>
                    <td>{{ total_pages_parts }}</td>
                </tr>
            </tbody>
        </table>

        <div class="text-center my-4">
            <button id="printTable" class="btn btn-secondary btn-sm mb-2">طباعة الجدول </button>
            <button id="exportExcel" class="btn btn-success btn-sm mb-2">تصدير إلى Excel</button>
            <a href="{% url 'halaqa_detail' id=halaqa.id %}" class="btn btn-secondary">العودة لتفاصيل الحلقة</a>
        </div>
    </div>
    {% include 'parts/footer.html' %}

    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script>
        // Add an ID to the memorization history table
        document.querySelector('table').id = 'memorizationTable';

        document.getElementById('printTable').addEventListener('click', function() {
            var mainTableContents = document.getElementById('memorizationTable').outerHTML;
            var summaryTableContents = document.getElementById('summaryTable').outerHTML;
            var printContents = mainTableContents + "<br>" + summaryTableContents; // Combine both tables
            var originalContents = document.body.innerHTML;
            var header = "<div style=\"text-align: center;\"><img src=\"{% static 'img/logo/الشعار صغير.png' %}\" alt=\"شعار\" width=\"200\"></div><br><h2>سجل الحفظ للحلقة: {{ halaqa.name }}</h2>"; // Updated header

            document.body.innerHTML = header + printContents;

            window.print();

            document.body.innerHTML = originalContents;
            // Reload the page to restore event listeners and functionality
            window.location.reload();
        });

        document.getElementById('exportExcel').addEventListener('click', function() {
            var table = document.getElementById('memorizationTable');
            var html = table.outerHTML;
            var url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'memorization_history.xls'; // Updated filename
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>