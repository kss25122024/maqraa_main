<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>إضافة التلقين اليومي</title>
    {% include 'parts/header.html' %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}"/>
    <style>
        body {
            direction: rtl;
            text-align: right;
        }
        .center-button {
            text-align: center;
            margin-top: 20px;
        }
        .card {
            margin: 20px 0;
        }
        .center-card {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header d-flex justify-content-between align-items-center">
            <div>
                <h1>مرحباً: {{ user.get_full_name }} </h1>
            </div>
            <div>
                <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary">تسجيل الخروج</button>
                </form>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <div class="col-md-6">
                <div class="card" style="background-color: #f2f2f0;">
                    <div class="card-body">
                        <h2>إضافة مهمة التلقين اليومية للطالب: {{ student.first_name }} {{ student.last_name }}</h2>
                        <form id="talqeenForm" method="post" action="{% url 'save_daily_talqeen_task' %}">
                            {% csrf_token %}
                            <input type="hidden" name="student_id" value="{{ student.id }}" />

                            <div class="form-group">
                                <label for="{{ form.TalqeenTask.id_for_label }}">مهمة تلقين</label>
                                {{ form.TalqeenTask }}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.previous_surah.id_for_label }}">السورة السابقة</label>
                                <select id="id_previous_surah" name="previous_surah" class="form-control">
                                    <option value="">اختر سورة</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.previous_ayat.id_for_label }}">الآية السابقة</label>
                                <select id="id_previous_ayat" name="previous_ayat" class="form-control">
                                    <option value="">اختر آية</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.current_surah.id_for_label }}">السورة الحالية</label>
                                <select id="id_current_surah" name="current_surah" class="form-control">
                                    <option value="">اختر سورة</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.current_ayat.id_for_label }}">الآية الحالية</label>
                                <select id="id_current_ayat" name="current_ayat" class="form-control">
                                    <option value="">اختر آية</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.pages.id_for_label }}">الصفحات</label>
                                {{ form.pages }}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.partial_page.id_for_label }}">صفحة جزئية</label>
                                {{ form.partial_page }}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.grade.id_for_label }}">التقدير</label>
                                {{ form.grade }}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.date.id_for_label }}">التاريخ</label>
                                {{ form.date }}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.memorized_ayat_count.id_for_label }}">عدد آيات التلقين</label>
                                {{ form.Talqeen_ayat_count }}
                            </div>

                            <button type="submit" class="btn btn-primary">حفظ</button>
                        </form>
                        <div class="center-button">
                            <a href="javascript:history.back()" class="btn btn-success">عودة</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script src="{% static 'js/7.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const talqeenTaskSelect = document.getElementById("id_TalqeenTask");
            const previousSurahSelect = document.getElementById("id_previous_surah");
            const currentSurahSelect = document.getElementById("id_current_surah");
            const previousAyatSelect = document.getElementById("id_previous_ayat");
            const currentAyatSelect = document.getElementById("id_current_ayat");

            const category_surahs = {
                "1": ["الفاتحة", "الناس", "الفلق", "الإخلاص", "المسد", "النصر", "الكافرون", "الكوثر", "الماعون", "قريش", "الفيل", "الهمزة", "العصر", "التكاثر", "القارعة", "العاديات", "الزلزلة", "البينة", "القدر", "العلق", "التين", "الشرح", "الضحى", "الليل", "الشمس", "البلد", "الفجر", "الغاشية", "الأعلى", "الطارق", "البروج", "الإنشقاق", "المطففين", "الانفطار", "التكوير", "عبس", "النازعات", "النبأ"],
                "2": ["المرسلات", "الإنسان", "القيامة", "المدثر", "المزمل", "الجن", "نوح", "المعارج", "الحاقة", "القلم", "الملك", "التحريم", "الطلاق", "التغابن", "المنافقون", "الجمعة", "الصف", "الممتحنة", "الحشر", "المجادلة"],
                "3": ["الحديد", "الواقعة", "الرحمن", "القمر", "النجم", "الطور", "الذاريات", "ق", "الحجرات", "الفتح", "محمد", "الأحقاف"],
                "4": ["الجاثية", "الدخان", "الزخرف", "الشورى", "فصلت", "غافر", "الزمر", "ص", "الصافات", "يس", "فاطر", "سبأ", "الأحزاب", "السجدة", "لقمان", "الروم"],
                "5": ["العنكبوت", "القصص", "النمل", "الشعراء", "الفرقان", "النور", "المؤمنون", "الحج", "الأنبياء", "طه", "مريم"],
                "6": ["الكهف", "الإسراء", "النحل", "الحجر", "إبراهيم", "الرعد", "يوسف", "هود", "يونس"],
                "7": ["التوبة", "الأنفال", "الأعراف", "الأنعام", "المائدة", "النساء", "آل عمران", "البقرة"]
            };

            const ayatCounts = {
                "الفاتحة": 7, "البقرة": 286, "آل عمران": 200, "النساء": 176, "المائدة": 120, "الأنعام": 165, "الأعراف": 206, "الأنفال": 75, "التوبة": 129, "يونس": 109, "هود": 123, "يوسف": 111, "الرعد": 43, "إبراهيم": 52, "الحجر": 99, "النحل": 128, "الإسراء": 111, "الكهف": 110, "مريم": 98, "طه": 135, "الأنبياء": 112, "الحج": 78, "المؤمنون": 118, "النور": 64, "الفرقان": 77, "الشعراء": 227, "النمل": 93, "القصص": 88, "العنكبوت": 69, "الروم": 60, "لقمان": 34, "السجدة": 30, "الأحزاب": 73, "سبأ": 54, "فاطر": 45, "يس": 83, "الصافات": 182, "ص": 88, "الزمر": 75, "غافر": 85, "فصلت": 54, "الشورى": 53, "الزخرف": 89, "الدخان": 59, "الجاثية": 37, "الأحقاف": 35, "محمد": 38, "الفتح": 29, "الحجرات": 18, "ق": 45, "الذاريات": 60, "الطور": 49, "النجم": 62, "القمر": 55, "الرحمن": 78, "الواقعة": 96, "الحديد": 29, "المجادلة": 22, "الحشر": 24, "الممتحنة": 13, "الصف": 14, "الجمعة": 11, "المنافقون": 11, "التغابن": 18, "الطلاق": 12, "التحريم": 12,             "الملك": 30, "القلم": 52, "الحاقة": 52, "المعارج": 44, "نوح": 28, "الجن": 28, "المزمل": 20, "المدثر": 56, "القيامة": 40, "الإنسان": 31, "المرسلات": 50, "النبأ": 40, "النازعات": 46, "عبس": 42, "التكوير": 29, "الانفطار": 19, "المطففين": 36, "الانشقاق": 25, "البروج": 22, "الطارق": 17, "الأعلى": 19, "الغاشية": 26, "الفجر": 30, "البلد": 20, "الشمس": 15, "الليل": 21, "الضحى": 11, "الشرح": 8, "التين": 8, "العلق": 19, "القدر": 5, "البينة": 8, "الزلزلة": 8, "العاديات": 11, "القارعة": 11, "التكاثر": 8, "العصر": 3, "الهمزة": 9, "الفيل": 5, "قريش": 4, "الماعون": 7, "الكوثر": 3, "الكافرون": 6, "النصر": 3, "المسد": 5, "الإخلاص": 4, "الفلق": 5, "الناس": 6
            };

            

            function updateSurahOptions(category) {
                const options = category_surahs[category] || [];
                previousSurahSelect.innerHTML = '<option value="">اختر سورة</option>';
                currentSurahSelect.innerHTML = '<option value="">اختر سورة</option>';
                options.forEach(surah => {
                    const optionElement = document.createElement("option");
                    optionElement.value = surah;
                    optionElement.text = surah;
                    previousSurahSelect.appendChild(optionElement.cloneNode(true));
                    currentSurahSelect.appendChild(optionElement);
                });
                // Reset ayah selections when surah options change
                previousAyatSelect.innerHTML = '<option value="">اختر آية</option>';
                currentAyatSelect.innerHTML = '<option value="">اختر آية</option>';
                return options; // Return the options
            }

           function updateAyatOptions(surah, ayatSelect) {
                const ayatCount = ayatCounts[surah] || 0;
                ayatSelect.innerHTML = '<option value="">اختر آية</option>';
                for (let i = 1; i <= ayatCount; i++) {
                    const optionElement = document.createElement("option");
                    optionElement.value = i;
                    optionElement.text = i;
                    ayatSelect.appendChild(optionElement);
                }
            }

            talqeenTaskSelect.addEventListener('change', function () {
                const category = talqeenTaskSelect.value;
                updateSurahOptions(category);
            });

            previousSurahSelect.addEventListener('change', function () {
                const selectedSurah = previousSurahSelect.value;
                updateAyatOptions(selectedSurah, previousAyatSelect);
            });

            currentSurahSelect.addEventListener('change', function () {
                const selectedSurah = currentSurahSelect.value;
                updateAyahOptions(selectedSurah, currentAyatSelect); // Corrected function call
            });

           // Set default category to '1' and load initial surahs and ayahs on page load
            // '1' corresponds to "المبتدئين" based on the category_surahs structure
            talqeenTaskSelect.value = '1';
            const initialSurahs = updateSurahOptions('1'); // Load surahs for the default category

            if (initialSurahs.length > 0) {
                const firstSurah = initialSurahs[0];
                previousSurahSelect.value = firstSurah;
                currentSurahSelect.value = firstSurah;
                updateAyatOptions(firstSurah, previousAyatSelect); // Load ayahs for the first surah in previous
                updateAyatOptions(firstSurah, currentAyatSelect); // Load ayahs for the first surah in current
            }


             const form = document.getElementById('talqeenForm');
             form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                    console.log(`Key: ${key}, Value: ${value}`); // Add this line to log each key-value pair
                });

            
             // أضف رمز لإرسال البيانات في النموذج كـ JSON
          




                
                console.log("Sending Data:", data);  // طباعة البيانات للتحقق منها

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                         // Check if student_id and halaqa_id are in the response for redirection
                        if (data.student_id && data.halaqa_id) {
                            // Construct the URL for halaqa_detail and redirect
                            window.location.href = `/halaqa/${data.halaqa_id}/`; // Assuming the URL pattern is /halaqa/<int:id>/
                        } else if (data.student_id) {
                             // If halaqa_id is not available, redirect to student_detail
                             window.location.href = `/student/${data.student_id}/`; // Assuming the URL pattern is /student/<int:student_id>/
                        }
                    } else if (data.error) {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("An error occurred while saving the task.");
                });
            });
        });
    </script>
</body>
</html>
